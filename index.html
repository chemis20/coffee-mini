<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>BrewPoint</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* (стили такие же, как вы использовали — лаконичные и адаптивные) */
    :root{
      --bg: #0f0e0d; --text:#f7f3ee; --muted:#cfc8c0;
      --brand:#b7895b; --brand-dark:#8b5e34; --card:rgba(255,255,255,0.08);
      --shadow:0 10px 30px rgba(0,0,0,.25); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased;padding-bottom:env(safe-area-inset-bottom);}
    .bg{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.75)),url('https://images.unsplash.com/photo-1494415859740-21e878dd929d?q=80&w=1800&auto=format&fit=crop');background-size:cover;background-position:center;z-index:-1}
    .wrap{width:100%;max-width:900px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .brand{font-weight:700;font-size:22px}
    .pill{background:rgba(255,255,255,.06);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted)}
    h1{font-size:24px;margin:12px 0}
    .section-title{font-size:18px;margin:10px 4px 10px;color:#f0e8df;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:480px){.grid{grid-template-columns:repeat(3,1fr);gap:14px}}
    .card{background:var(--card);border-radius:var(--radius);overflow:hidden;border:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;box-shadow:var(--shadow)}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
    .card-body{padding:10px;display:flex;flex-direction:column;flex:1}
    .card h3{margin:0 0 6px;font-size:15.5px}
    .desc{margin:0 0 8px;color:var(--muted);font-size:13px;min-height:2.6em}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:auto}
    .price{color:var(--brand);font-weight:700}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:9px 12px;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    #cart{position:sticky;bottom:0;background:rgba(24,23,22,.92);padding:12px;border-top:1px solid rgba(255,255,255,.06);border-radius:12px 12px 0 0;margin-top:18px}
    #cart-list{list-style:none;margin:0;padding:0;max-height:26vh;overflow:auto}
    .rem{background:#e74c3c;color:#fff;border:none;border-radius:8px;padding:4px 8px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;padding:16px}
    .modal-content{max-width:520px;margin:auto;background:#1b1917;color:var(--text);border-radius:20px;padding:18px;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)}
    .close-x{position:absolute;right:12px;top:10px;background:none;border:none;color:#fff;font-size:20px}
    .mod-item{display:flex;align-items:center;gap:10px;padding:8px 2px}
    .mod-item input{width:18px;height:18px}
    .time-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
    .upsell-box{border-radius:14px;padding:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04)}
    .deal{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:12px;background:rgba(0,0,0,.2)}
    .btn-ghost{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);padding:9px 12px;border-radius:12px;color:#fff}
    .total{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="wrap">
    <header>
      <div class="brand">BrewPoint</div>
      <div class="pill">Сегодня: 08:00–21:00</div>
    </header>

    <h1>Меню</h1>

    <!-- Кофе -->
    <div class="section">
      <div class="section-title">Кофе</div>
      <div class="grid" id="coffee-grid">
        <div class="card">
          <img class="thumb" src="https://images.unsplash.com/photo-1572442388796-11668a67e53d?auto=format&fit=crop&w=600&q=80">
          <div class="card-body">
            <h3>Латте</h3>
            <p class="desc">Мягкий молочный кофе</p>
            <div class="row">
              <div class="price" data-base="200">200₽</div>
              <button class="btn" onclick="openMods('Латте',200)">В корзину</button>
            </div>
          </div>
        </div>

        <div class="card">
          <img class="thumb" src="https://images.unsplash.com/photo-1541167760496-1628856ab772?auto=format&fit=crop&w=600&q=80">
          <div class="card-body">
            <h3>Капучино</h3>
            <p class="desc">Насыщенный с молочной пенкой</p>
            <div class="row">
              <div class="price" data-base="180">180₽</div>
              <button class="btn" onclick="openMods('Капучино',180)">В корзину</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Десерты -->
    <div class="section">
      <div class="section-title">Десерты</div>
      <div class="grid" id="dessert-grid">
        <div class="card">
          <img class="thumb" src="https://images.unsplash.com/photo-1587314168485-3236d6710814?auto=format&fit=crop&w=600&q=80">
          <div class="card-body">
            <h3>Круассан</h3>
            <p class="desc">Тёплый, слоёный</p>
            <div class="row">
              <div class="price" data-base="120">120₽</div>
              <button class="btn" onclick="addToCart('Круассан',120,null)">В корзину</button>
            </div>
          </div>
        </div>
        <div class="card">
          <img class="thumb" src="https://images.unsplash.com/photo-1607478900766-efe13248b125?auto=format&fit=crop&w=600&q=80">
          <div class="card-body">
            <h3>Чизкейк</h3>
            <p class="desc">Нежный творожный</p>
            <div class="row">
              <div class="price" data-base="220">220₽</div>
              <button class="btn" onclick="addToCart('Чизкейк',220,null)">В корзину</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Корзина -->
    <div id="cart">
      <h2>Корзина</h2>
      <ul id="cart-list"></ul>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted" id="timeLine">Время: не выбрано</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="total">Итого: <span id="total">0</span>₽</div>
        <button class="btn" onclick="pay()">Оплатить</button>
      </div>
    </div>
  </div>

  <!-- Модалки -->
  <div id="modsModal" class="modal"><div class="modal-content">
    <button class="close-x" onclick="closeMods()">×</button>
    <h3>Выберите модификаторы</h3>
    <div id="modsList"></div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" onclick="confirmMods()">Далее к времени</button>
      <button class="btn-ghost" onclick="closeMods()">Отмена</button>
    </div>
  </div></div>

  <div id="timeModal" class="modal"><div class="modal-content">
    <button class="close-x" onclick="closeTime()">×</button>
    <h3>Когда приготовить?</h3>
    <div class="time-grid">
      <button class="time-btn" onclick="selectTime('Сейчас')">Сейчас</button>
      <button class="time-btn" onclick="selectTime('Через 30 мин')">Через 30 мин</button>
      <button class="time-btn" onclick="selectTime('Через 1 час')">Через 1 час</button>
    </div>
    <div style="margin-top:10px">
      <label class="muted">Свое время: <input id="customTime" type="time" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:6px"></label>
      <div style="margin-top:8px"><button class="btn" onclick="selectCustom()">Выбрать</button></div>
    </div>
  </div></div>

  <div id="upsellModal" class="modal"><div class="modal-content">
    <button class="close-x" onclick="closeUpsell()">×</button>
    <h3>Добавьте десерт и получите скидку</h3>
    <div class="muted" id="upsellHint" style="margin-bottom:8px"></div>
    <div id="upsellDeals" class="upsell-box"></div>
    <div style="margin-top:12px"><button class="btn-ghost" onclick="skipUpsell()">Продолжить без десертов</button></div>
  </div></div>

  <div id="checkoutModal" class="modal"><div class="modal-content">
    <button class="close-x" onclick="closeCheckout()">×</button>
    <h3>Проверьте заказ</h3>
    <p><b>Адрес:</b> <span id="cafeAddress">ул. Ленина, 10 (BrewPoint)</span></p>
    <ul id="finalList" style="margin:8px 0;padding-left:18px"></ul>
    <p><b>Время:</b> <span id="finalTime">—</span></p>
    <p style="margin-top:8px"><b>Сумма к оплате:</b> <span id="finalTotal">0</span>₽</p>
    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn-ghost" onclick="closeCheckout()">Вернуться к каталогу</button>
      <button class="btn" onclick="fakePay()">Оплатить</button>
    </div>
  </div></div>

  <div id="successModal" class="modal"><div class="modal-content">
    <button class="close-x" onclick="closeSuccess()">×</button>
    <h3>Заказ оформлен!</h3>
    <ul id="successList" style="margin:8px 0;padding-left:18px"></ul>
    <p>Номер заказа: #<span id="orderNumber">12345</span></p>
    <div style="margin-top:12px"><button class="btn" onclick="closeMiniApp()">Вернуться в чат</button></div>
  </div></div>

<script>
  Telegram.WebApp.ready();
  // Telegram.WebApp.expand();  // не всегда нужно, но можно активировать

  // ========== Настройки (замените значения) ==========
  const SERVER_URL = "https://eok4k766hks0b1f.m.pipedream.net"; // <-- ваш Pipedream URL
  const WEBHOOK_SECRET = "s3cr3t_brew";                        // <-- секрет для Pipedream (совпадает с header)
  const cafeAddress = "ул. Ленина, 10 (BrewPoint)";
  // ===================================================

  // состояние
  let cart = []; // {name, price, time}
  let selectedTime = null;
  let currentItem = null;
  let pendingAfterUpsell = false;
  let forcedTotal = null; // если апселл поменял итоговую сумму

  const MODS = [
    { id:'sugar', title:'1 ложка сахара', add:0 },
    { id:'vanilla', title:'Ванильный сироп', add:20 },
    { id:'caramel', title:'Карамельный сироп', add:20 },
    { id:'choco', title:'Шоколадный сироп', add:20 }
  ];

  const $ = s => document.querySelector(s);
  const show = el => el.style.display = 'block';
  const hide = el => el.style.display = 'none';

  function updateCart(){
    const list = $('#cart-list'); list.innerHTML = '';
    cart.forEach((it, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${it.name} — ${it.price}₽${it.time ? ' • '+it.time : ''}</span><button class="rem" onclick="removeItem(${idx})">×</button>`;
      list.appendChild(li);
    });
    const total = cart.reduce((s,i)=>s+i.price,0);
    $('#total').textContent = total;
    $('#timeLine').textContent = `Время: ${selectedTime||'не выбрано'}`;
  }
  function addToCart(name, price, time){
    cart.push({name, price, time});
    updateCart();
  }
  function removeItem(idx){ cart.splice(idx,1); updateCart(); }

  // модификаторы
  function openMods(name, basePrice){
    currentItem = {name, basePrice, mods:[], finalName:name, finalPrice:basePrice};
    const holder = $('#modsList'); holder.innerHTML = '';
    MODS.forEach(m=>{
      const row = document.createElement('div'); row.className = 'mod-item';
      row.innerHTML = `<input type="checkbox" id="m_${m.id}" data-add="${m.add}"><label for="m_${m.id}" class="mod-label">${m.title} <span class="muted">${m.add?`(+${m.add}₽)`:''}</span></label>`;
      holder.appendChild(row);
    });
    show($('#modsModal'));
  }
  function closeMods(){ hide($('#modsModal')); }
  function confirmMods(){
    if(!currentItem) return;
    let add=0; const picked=[];
    MODS.forEach(m=>{
      const el = document.getElementById(`m_${m.id}`);
      if(el && el.checked){ add += Number(el.dataset.add||0); picked.push(m.title); }
    });
    currentItem.mods = picked; currentItem.finalName = currentItem.name + (picked.length?` (${picked.join(', ')})`:'');
    currentItem.finalPrice = currentItem.basePrice + add;
    hide($('#modsModal'));
    openTime();
  }

  // время
  function openTime(){ show($('#timeModal')); }
  function closeTime(){ hide($('#timeModal')); }
  function selectTime(t){
    selectedTime = t;
    addToCart(currentItem.finalName, currentItem.finalPrice, selectedTime);
    closeTime();
  }
  function selectCustom(){
    const v = $('#customTime').value; if(!v){ alert('Укажите время'); return; }
    selectedTime = v; addToCart(currentItem.finalName, currentItem.finalPrice, selectedTime); closeTime();
  }

  // оплата + upsell
  function pay(){
    if(cart.length===0){ alert('Корзина пуста'); return; }
    const onlyDrinks = cart.length>0 && cart.every(i=>['латте','капучино','эспрессо','капучино'].some(n=>i.name.toLowerCase().includes(n)));
    if(onlyDrinks){
      buildUpsell(); pendingAfterUpsell = true; show($('#upsellModal')); return;
    }
    openCheckout();
  }
  function closeUpsell(){ hide($('#upsellModal')); }
  function skipUpsell(){ closeUpsell(); if(pendingAfterUpsell) openCheckout(); }

  function buildUpsell(){
    const subtotal = cart.reduce((s,i)=>s+i.price,0);
    const oneDessert = 120, twoDesserts = 120+220;
    const total1 = Math.round((subtotal + oneDessert) * 0.90);
    const total2 = Math.round((subtotal + twoDesserts) * 0.85);
    $('#upsellHint').textContent = 'Скидка −10% при 1 десерте, −15% при 2.';
    $('#upsellDeals').innerHTML = `
      <div class="deal"><div><strong>Напитки + 1 десерт</strong><div class="muted">Круассан (120₽) • −10%</div></div>
        <div><div class="price">${total1}₽</div><button class="btn" onclick="applyUpsell(1,${total1})">Добавить</button></div></div>
      <div style="height:8px"></div>
      <div class="deal"><div><strong>Напитки + 2 десерта</strong><div class="muted">Круассан+Чизкейк (340₽) • −15%</div></div>
        <div><div class="price">${total2}₽</div><button class="btn" onclick="applyUpsell(2,${total2})">Добавить</button></div></div>
    `;
  }
  function applyUpsell(count, finalTotal){
    if(count>=1) addToCart('Круассан (апселл)',120,selectedTime);
    if(count>=2) addToCart('Чизкейк (апселл)',220,selectedTime);
    forcedTotal = finalTotal; // покажем итоговую сумму (со скидкой)
    closeUpsell(); openCheckout(forcedTotal);
  }

  // чек и оплата
  function openCheckout(forced){
    const list = $('#finalList'); list.innerHTML = cart.map(i=>`<li>${i.name} — ${i.price}₽${i.time? ' • '+i.time:''}</li>`).join('');
    $('#finalTime').textContent = selectedTime || '—';
    const normal = cart.reduce((s,i)=>s+i.price,0);
    $('#finalTotal').textContent = forced || normal;
    $('#checkoutModal').style.display = 'block';
  }
  function closeCheckout(){ $('#checkoutModal').style.display='none'; }

  // финальный платеж — сразу отправляем в Pipedream и в WebApp.sendData (попытка)
  async function fakePay(){
    // формируем полезную нагрузку
    const payload = {
      command: 'order',
      order_id: Math.floor(Math.random()*9000000),
      tg_user_id: Telegram?.WebApp?.initDataUnsafe?.user?.id || null,
      items: cart,
      total: Number(document.getElementById('finalTotal').textContent),
      time: selectedTime || null,
      address: cafeAddress
    };

    // 1) POST на Pipedream
    try {
      const resp = await fetch(SERVER_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json; charset=utf-8",
          "X-Webhook-Secret": WEBHOOK_SECRET
        },
        body: JSON.stringify(payload)
      });
      if(!resp.ok) console.warn('Webhook status', resp.status);
      else {
        try { const j = await resp.json(); console.log('Webhook resp', j); } catch(e){ console.log('Webhook ok'); }
      }
    } catch(e){ console.error('Webhook error', e); }

    // 2) Telegram.WebApp.sendData дублёр (если открыт через WebApp)
    try {
      Telegram.WebApp.sendData(JSON.stringify(payload));
    } catch(e){ console.warn('sendData failed', e); }

    // 3) Показываем успех
    document.getElementById('successList').innerHTML = cart.map(i=>`<li>${i.name} — ${i.price}₽${i.time? ' • '+i.time:''}</li>`).join('');
    document.getElementById('orderNumber').textContent = payload.order_id;
    closeCheckout();
    show($('#successModal'));

    // очищаем корзину (после показа, чтобы пользователь видел что было)
    cart = [];
    selectedTime = null;
    forcedTotal = null;
    setTimeout(()=>updateCart(), 300);
  }

  function closeSuccess(){ hide($('#successModal')); }
  function closeMiniApp(){ try{ Telegram.WebApp.close(); }catch(e){console.warn(e)} }

  // инициализация
  updateCart();
</script>
</body>
</html>
